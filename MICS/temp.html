<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Opinions with Multiple Images</title>
    <style>
      .image-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        grid-gap: 10px;
      }

      .image-preview {
        width: 100%;
        height: auto;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="chat-messages"></div>

    <form onsubmit="event.preventDefault(); postOpinion();">
      <input type="text" id="username" placeholder="Username" required />
      <input type="email" id="email" placeholder="Email" required />
      <textarea id="opinion" placeholder="Opinion" required></textarea>
      <input type="text" id="deleteCode" placeholder="Delete Code" required />
      <input type="file" id="imageFiles" multiple />
      <button type="submit">Submit</button>
    </form>

    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-storage.js"></script>

    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyC9JYxmu2_9EovJdkrd3W4vII5u6nInMfA",
        authDomain: "mold-skill-eafde.firebaseapp.com",
        databaseURL: "https://mold-skill-eafde-default-rtdb.firebaseio.com",
        projectId: "mold-skill-eafde",
        storageBucket: "mold-skill-eafde.appspot.com",
        messagingSenderId: "648939616010",
        appId: "1:648939616010:web:11f7961cc838f25e262cf3",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      // Retrieve a reference to the Firebase database
      var database = firebase.database();

      // Get the reference to the "opinions" node in the database
      var opinionsRef = database.ref("opinions");

      // Listen for new opinions and update the UI
      opinionsRef.on("child_added", function (data) {
        var opinion = data.val();
        displayMessage(opinion, data.key);
      });

      function displayMessage(opinion, messageId) {
        var chatMessages = document.getElementById("chat-messages");

        var messageContainer = document.createElement("div");
        messageContainer.classList.add("message-container");

        var sender = document.createElement("p");
        sender.classList.add("sender");
        sender.textContent = "By: " + opinion.sender;

        var text = document.createElement("p");
        text.classList.add("txt");
        text.textContent = "Opinion: " + opinion.opinion;

        var deleteButton = document.createElement("button");
        deleteButton.innerHTML = '<i class="fas fa-trash"></i> Delete';
        deleteButton.classList.add("delete-button");

        deleteButton.addEventListener("click", function () {
          var deleteCode = prompt("Enter the delete code:");
          if (deleteCode === opinion.deleteCode) {
            opinionsRef.child(messageId).remove();
            messageContainer.remove();
          } else {
            alert("The delete code you provided doesn't match.");
          }
        });

        messageContainer.appendChild(sender);
        messageContainer.appendChild(text);

        if (opinion.imageUrls && opinion.imageUrls.length > 0) {
          var imageContainer = document.createElement("div");
          imageContainer.classList.add("image-container");

          for (var i = 0; i < opinion.imageUrls.length; i++) {
            var image = document.createElement("img");
            image.src = opinion.imageUrls[i];
            image.classList.add("image-preview");

            image.addEventListener("click", function () {
              window.open(this.src, "_blank");
            });

            imageContainer.appendChild(image);
          }

          messageContainer.appendChild(imageContainer);
        }

        messageContainer.appendChild(deleteButton);
        chatMessages.appendChild(messageContainer);
      }

      function postOpinion() {
        var username = document.getElementById("username").value;
        var email = document.getElementById("email").value;
        var opinion = document.getElementById("opinion").value;
        var deleteCode = document.getElementById("deleteCode").value;
        var files = document.getElementById("imageFiles").files;

        if (validateInputs(username, email, opinion, deleteCode, files)) {
          var imageUrls = [];

          if (files.length > 0) {
            var fileCount = files.length;
            var uploadedCount = 0;

            for (var i = 0; i < fileCount; i++) {
              var file = files[i];
              if (file.size <= 4 * 1024 * 1024) {
                var storageRef = firebase.storage().ref("images/" + file.name);
                var uploadTask = storageRef.put(file);

                uploadTask.then(function (snapshot) {
                  snapshot.ref.getDownloadURL().then(function (url) {
                    imageUrls.push(url);
                    uploadedCount++;

                    if (uploadedCount === fileCount) {
                      saveOpinion(username, email, opinion, deleteCode, imageUrls);
                    }
                  });
                });
              } else {
                alert("Please select image files smaller than 4 MB.");
              }
            }
          } else {
            saveOpinion(username, email, opinion, deleteCode, imageUrls);
          }

          clearInputs();
        }
      }

      function saveOpinion(username, email, opinion, deleteCode, imageUrls) {
        opinionsRef.push({
          sender: username,
          email: email,
          opinion: opinion,
          deleteCode: deleteCode,
          imageUrls: imageUrls,
          timestamp: new Date().getTime(),
        });
      }

      function validateInputs(username, email, opinion, deleteCode, files) {
        if (!username || !email || !opinion || !deleteCode) {
          alert("Please fill in all the required fields.");
          return false;
        }

        if (!isValidEmail(email)) {
          alert("Please enter a valid email address.");
          return false;
        }

        if (files && files.length > 0) {
          for (var i = 0; i < files.length; i++) {
            var file = files[i];
            if (file.size > 4 * 1024 * 1024) {
              alert("Please select image files smaller than 4 MB.");
              return false;
            }
          }
        }

        return true;
      }

      function isValidEmail(email) {
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function clearInputs() {
        document.getElementById("username").value = "";
        document.getElementById("email").value = "";
        document.getElementById("opinion").value = "";
        document.getElementById("deleteCode").value = "";
        document.getElementById("imageFiles").value = null;
      }
    </script>
  </body>
</html>
